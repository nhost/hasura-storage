version: '2.4'
services:
  postgres:
    image: postgres:13
    volumes:
      - ./initdb.d:/docker-entrypoint-initdb.d:ro
    ports:
      - '5432:5432'
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hejsan}

  graphql-engine:
    container_name: graphql-engine
    build:
      context: hasura
    depends_on:
      - postgres
      - minio
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
    ports:
      - '8080:8080'
    environment:
      HASURA_GRAPHQL_DATABASE_URL: ${HASURA_GRAPHQL_DATABASE_URL:-postgres://postgres:hejsan@postgres:5432/postgres}
      HASURA_GRAPHQL_ENABLE_CONSOLE: ${HASURA_GRAPHQL_ENABLE_CONSOLE:-true}
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_GRAPHQL_ADMIN_SECRET:-hello123}
      HASURA_GRAPHQL_JWT_SECRET: ${HASURA_GRAPHQL_JWT_SECRET:-{"type":"HS256", "key":"5152fa850c02dc222631cca898ed1485821a70912a6e3649c49076912daa3b62182ba013315915d64f40cddfbb8b58eb5bd11ba225336a6af45bbae07ca873f3"}}
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: ${HASURA_GRAPHQL_UNAUTHORIZED_ROLE:-public}
      HASURA_GRAPHQL_LOG_LEVEL: ${HASURA_GRAPHQL_LOG_LEVEL:-info}
      HASURA_GRAPHQL_DEV_MODE: ${HASURA_GRAPHQL_DEV_MODE:-false}

  minio:
    build:
      context: minio
    container_name: minio
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-5a7bdb5f42c41e0622bf61d6e08d5537}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-9e1c40c65a615a5b52f52aeeaf549944ec53acb1dff4a0bf01fb58e969f915c8}
    command: server --address 0.0.0.0:9000 --console-address 0.0.0.0:32765 /tmp
    ports:
      - '9000:9000'
      - '32765:32765'

  storage:
    image: hasura-storage:latest
    depends_on:
      graphql-engine:
        condition: service_healthy
    ports:
      - '8000:8000'
      - '8001:8001'
    environment:
      # DEBUG: "true"
      HASURA_ENDPOINT: http://graphql-engine:8080/v1
      HASURA_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-hello123}
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-5a7bdb5f42c41e0622bf61d6e08d5537}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-9e1c40c65a615a5b52f52aeeaf549944ec53acb1dff4a0bf01fb58e969f915c8}
      S3_REGION: "us-east-1"
      S3_BUCKET: "default"
      S3_ROOT_FOLDER: "f215cf48-7458-4596-9aa5-2159fc6a3caf"
    command: serve --postgres-migrations --postgres-migrations-source ${HASURA_GRAPHQL_DATABASE_URL:-postgres://postgres:hejsan@postgres:5432/postgres?sslmode=disable} --hasura-metadata --hasura-admin-secret ${HASURA_ADMIN_SECRET:-hello123} 

  hasura-storage-node:
    container_name: hasura-storage
    image: nhost/hasura-storage:latest
    restart: always
    ports:
      - '4000:4000'
    environment:
      STORAGE_PORT: ${STORAGE_PORT:-4000}
      STORAGE_HOST: ${STORAGE_HOST:-0.0.0.0}
      STORAGE_STANDALONE_MODE: ${STORAGE_STANDALONE_MODE:-true}
      STORAGE_PUBLIC_URL: ${STORAGE_PUBLIC_URL:-http://localhost:4000}
      STORAGE_LOG_LEVEL: ${STORAGE_LOG_LEVEL:-info}
      STORAGE_FORCE_DOWNLOAD_FOR_CONTENT_TYPES: ${STORAGE_FORCE_DOWNLOAD_FOR_CONTENT_TYPES:-text/html,application/javascript}
      STORAGE_SWAGGER_ENABLED: ${STORAGE_SWAGGER_ENABLED:-true}
      S3_ENDPOINT: ${S3_ENDPOINT:-minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-5a7bdb5f42c41e0622bf61d6e08d5537}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-9e1c40c65a615a5b52f52aeeaf549944ec53acb1dff4a0bf01fb58e969f915c8}
      S3_BUCKET: "default"
      S3_ROOT_FOLDER: "f215cf48-7458-4596-9aa5-2159fc6a3caf"
      HASURA_GRAPHQL_DATABASE_URL: ${HASURA_GRAPHQL_DATABASE_URL:-postgres://postgres:hejsan@postgres:5432/postgres}
      HASURA_GRAPHQL_GRAPHQL_URL: ${HASURA_GRAPHQL_GRAPHQL_URL:-http://graphql-engine:8080/v1/graphql}
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_GRAPHQL_ADMIN_SECRET:-hello123}
